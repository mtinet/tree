<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì†Œë§ì˜ ë‚˜ë¬´ - ë¼ì´ë¸Œ ì—´ë§¤ ì›”</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&family=Jua&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #607D8B;
        }

        #bg-video {
            position: fixed;
            top: 50%;
            left: 50%;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            transform: translate(-50%, -50%);
            z-index: -1;
            object-fit: cover;
            filter: brightness(0.9);
        }

        #message-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        /* [ìˆ˜ì •ë¨] ì•ˆë‚´ ë¬¸êµ¬ ì»¨í…Œì´ë„ˆ */
        #guide-text {
            position: fixed;
            bottom: 30px;
            left: 30px;
            font-family: 'Jua', sans-serif;
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 1px 1px 4px rgba(0,0,0,0.6);
            z-index: 100;
            pointer-events: none; 
            
            /* Flexbox ê°€ë¡œ ì •ë ¬ */
            display: flex;
            /* [í•µì‹¬ ìˆ˜ì •] ì•„ë˜ìª½ ê¸°ì¤€ ì •ë ¬ë¡œ ë³€ê²½ */
            align-items: flex-end; 
        }

        /* QRì½”ë“œ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        #guide-qr {
            width: 84px;
            height: 84px;
            background-color: white;
            padding: 6px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            margin-right: 15px; 
            margin-bottom: 0;
        }

        /* [ìˆ˜ì •ë¨] í…ìŠ¤íŠ¸ ìœ„ì¹˜ ì¡°ì • */
        .guide-msg {
            /* ê¸°ì¡´ ìƒë‹¨ ì—¬ë°± ì œê±° (í•˜ë‹¨ ì •ë ¬ì´ë¯€ë¡œ í•„ìš” ì—†ìŒ) */
            /* margin-top: 10px; */ 
        }

        /* ì´ˆê¸°í™” ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #reset-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-family: 'Jua', sans-serif;
            font-size: 1rem;
            cursor: pointer;
            z-index: 200;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            opacity: 0.3; 
            transition: opacity 0.3s, background 0.3s;
        }
        #reset-btn:hover {
            opacity: 1;
            background-color: #1976D2;
        }

        .fruit-card {
            position: absolute;
            border-radius: 50%;
            color: #4a3b2a;
            text-align: center;
            box-shadow: 2px 5px 15px rgba(0,0,0,0.25);
            font-family: 'Gaegu', cursive;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
            background-color: rgba(255,255,255,0.95);
            transform-origin: top center; 
            opacity: 0;
            transform: scale(0);
            transition: opacity 0.5s ease;
        }

        .fruit-card::before {
            content: '';
            position: absolute;
            top: -10px; left: 50%;
            transform: translateX(-50%);
            width: 6px; height: 14px;
            background-color: #5D4037;
            border-radius: 3px;
        }

        .fruit-card::after {
            content: '';
            position: absolute;
            top: -14px; left: 50%;
            width: 20px; height: 10px;
            background-color: #66BB6A;
            border-radius: 10px 0px 10px 0px;
            transform: rotate(-15deg);
        }

        .nickname { 
            margin-top: -10px; 
            margin-bottom: 2px;
            flex-shrink: 0; 
            opacity: 0.6; 
            font-family: 'Jua', sans-serif;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 90%;
        }
        
        .content { 
            font-weight: bold; 
            word-break: break-all;
            line-height: 1.25;
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 6; 
        }

        @keyframes swing {
            0% { transform: rotate(3deg); }
            100% { transform: rotate(-3deg); }
        }
        .hanging { animation: swing 2.5s ease-in-out infinite alternate; }
        .show { opacity: 1; transform: scale(1); }
    </style>
</head>
<body>

    <video id="bg-video" autoplay muted loop playsinline poster="https://images.unsplash.com/photo-1502082553048-f009c37129b9?q=80&w=2000&auto=format&fit=crop">
        <source src="https://videos.pexels.com/video-files/4958636/4958636-hd_1920_1080_30fps.mp4" type="video/mp4">
        ë¸Œë¼ìš°ì €ê°€ ë™ì˜ìƒì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    </video>

    <div id="guide-text">
        <img src="https://github.com/mtinet/tree/raw/main/qr.png?raw=true" alt="QRì½”ë“œ" id="guide-qr">
        <div class="guide-msg">ë©”ì‹œì§€ëŠ” 60ì ì´ë‚´ë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”</div>
    </div>
    
    <button id="reset-btn">ì „ì²´ ì´ˆê¸°í™” ğŸ”„</button>

    <div id="message-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, onChildAdded, get, remove } 
        from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // ==========================================
        // [1] ê¸°ë³¸ ì„¸íŒ… ë©”ì‹œì§€
        // ==========================================
        const defaultMessages = [
            { id: 'def1', nickname: 'ìˆ²ì§€ê¸°', text: 'ì†Œë§ì˜ ë‚˜ë¬´ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!' },
            { id: 'def2', nickname: 'ì•ˆë‚´', text: 'QRì½”ë“œë¥¼ ì°ì–´ ì†Œì›ì„ ë‚¨ê²¨ë³´ì„¸ìš”.' },
            { id: 'def3', nickname: 'í–‰ìš´', text: 'ì—¬ëŸ¬ë¶„ì˜ ê¿ˆì´ ëª¨ë‘ ì´ë£¨ì–´ì§€ê¸¸ ë°”ëë‹ˆë‹¤.' },
            { id: 'def4', nickname: 'ë‚˜ë¬´', text: 'í–‰ë³µí•œ í•˜ë£¨ ë³´ë‚´ì„¸ìš”!' }
        ];

        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyAnansDDKLmGrWO3UtpfxEavdJ_ULiZqBU",
            authDomain: "tree-a841c.firebaseapp.com",
            databaseURL: "https://tree-a841c-default-rtdb.firebaseio.com",
            projectId: "tree-a841c",
            storageBucket: "tree-a841c.firebasestorage.app",
            messagingSenderId: "847725327099",
            appId: "1:847725327099:web:bf3b4529b8fae3c641b65e",
            measurementId: "G-N8GMR87FSW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const messagesRef = ref(db, 'messages');

        // ì „ì²´ ë©”ì‹œì§€ ëª©ë¡ ì´ˆê¸°í™”
        let allMessages = [...defaultMessages]; 
        
        let priorityQueue = [];
        let currentOnScreenIds = new Set();
        let isInitialLoadDone = false;

        // 2. ê¸°ì¡´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        get(messagesRef).then((snapshot) => {
            if (snapshot.exists()) {
                snapshot.forEach((childSnapshot) => {
                    const data = childSnapshot.val();
                    allMessages.push({ id: childSnapshot.key, nickname: data.nickname, text: data.text });
                });
                console.log("ê¸°ì¡´ ë°ì´í„° ë¡œë“œ ì™„ë£Œ. ì´ ê°œìˆ˜:", allMessages.length);
            }
            isInitialLoadDone = true;
        }).catch((error) => {
            console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
            isInitialLoadDone = true; 
        });

        // 3. ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ
        onChildAdded(messagesRef, (snapshot) => {
            if (!isInitialLoadDone) return; 

            const data = snapshot.val();
            const newMsg = { id: snapshot.key, nickname: data.nickname, text: data.text };
            
            console.log("ìƒˆ ë©”ì‹œì§€ ë„ì°©!", newMsg);
            
            allMessages.push(newMsg); 
            priorityQueue.push(newMsg); 
        });

        // ---------------- [UI í‘œì‹œ ë¡œì§] ----------------
        const fruitColors = ['#FF9AA2', '#FFB7B2', '#FFDAC1', '#E2F0CB', '#B5EAD7', '#C7CEEA', '#F1C0E8', '#A0E7E5'];
        const container = document.getElementById('message-container');
        let zIndex = 1;

        // ì´ˆê¸°í™” ë²„íŠ¼ ë¡œì§
        const resetBtn = document.getElementById('reset-btn');
        resetBtn.addEventListener('click', () => {
            if (confirm("ëª¨ë“  ë©”ì‹œì§€ë¥¼ ì‚­ì œí•˜ê³  ì´ˆê¸° ìƒíƒœë¡œ ë˜ëŒë¦¬ê² ìŠµë‹ˆê¹Œ?\n(ê¸°ë³¸ ë©”ì‹œì§€ëŠ” ë‹¤ì‹œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤)")) {
                remove(messagesRef).then(() => {
                    alert("ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    
                    // 1. í™”ë©´ ë¹„ìš°ê¸°
                    container.innerHTML = '';
                    currentOnScreenIds.clear();
                    
                    // 2. ë°ì´í„° ë¦¬ì…‹
                    allMessages = [...defaultMessages];
                    priorityQueue = [];

                    // 3. ì¦‰ì‹œ ëª‡ ê°œ ë„ì›Œì£¼ê¸°
                    for(let i=0; i<3; i++) {
                        setTimeout(displayMessage, i * 600);
                    }
                    
                }).catch((error) => {
                    console.error("ì‚­ì œ ì‹¤íŒ¨:", error);
                    alert("ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                });
            }
        });

        function isOverlapping(newRect) {
            const cards = document.querySelectorAll('.fruit-card.show');
            for (let card of cards) {
                const rect = card.getBoundingClientRect();
                if (!(newRect.right < rect.left || 
                      newRect.left > rect.right || 
                      newRect.bottom < rect.top || 
                      newRect.top > rect.bottom)) {
                    return true; 
                }
            }
            return false;
        }

        function displayMessage() {
            let messageData;

            // 1ìˆœìœ„: ì‹¤ì‹œê°„ í
            if (priorityQueue.length > 0) {
                messageData = priorityQueue.shift();
            } 
            // 2ìˆœìœ„: ì „ì²´ ë©”ì‹œì§€ (í™”ë©´ì— ì—†ëŠ” ê²ƒ)
            else {
                if (allMessages.length === 0) return; 
                
                const available = allMessages.filter(m => !currentOnScreenIds.has(m.id));
                
                // í™”ë©´ì— ê½‰ ì°¼ìœ¼ë©´ ëŒ€ê¸°
                if (available.length === 0) {
                    return; 
                }

                messageData = available[Math.floor(Math.random() * available.length)];
            }

            const card = document.createElement('div');
            card.className = `fruit-card`;
            card.style.backgroundColor = fruitColors[Math.floor(Math.random() * fruitColors.length)];
            
            const textLen = messageData.text.length;
            
            let settings = {
                size: 95, padding: '12px', nickSize: '0.7rem', contentSize: '0.9rem'
            };

            if (textLen > 45) {
                settings = { size: 200, padding: '25px', nickSize: '1rem', contentSize: '1.1rem' };
            } else if (textLen > 30) {
                settings = { size: 170, padding: '20px', nickSize: '0.9rem', contentSize: '1.05rem' };
            } else if (textLen > 20) {
                settings = { size: 145, padding: '18px', nickSize: '0.85rem', contentSize: '1rem' };
            } else if (textLen > 10) {
                settings = { size: 120, padding: '15px', nickSize: '0.8rem', contentSize: '0.95rem' };
            }
            
            card.style.width = `${settings.size}px`;
            card.style.height = `${settings.size}px`;
            card.style.padding = settings.padding;

            // ì¢Œí‘œ ê³„ì‚°
            let top, left, attempts = 0;
            do {
                const zoneSelector = Math.random();
                if (zoneSelector < 0.35) {
                    left = Math.random() * (window.innerWidth * 0.40) + (window.innerWidth * 0.05);
                    top = Math.random() * (window.innerHeight * 0.4) + (window.innerHeight * 0.2);
                } else if (zoneSelector < 0.75) {
                    left = Math.random() * (window.innerWidth * 0.35) + (window.innerWidth * 0.3);
                    top = Math.random() * (window.innerHeight * 0.48) + (window.innerHeight * 0.02);
                } else {
                    left = Math.random() * (window.innerWidth * 0.25) + (window.innerWidth * 0.6);
                    top = Math.random() * (window.innerHeight * 0.35) + (window.innerHeight * 0.4);
                }
                attempts++;
            } while (isOverlapping({left, top, right: left + settings.size, bottom: top + settings.size}) && attempts < 50);

            if (attempts >= 50) return;

            card.style.top = `${top}px`;
            card.style.left = `${left}px`;
            card.style.zIndex = zIndex++;
            card.style.animationDelay = `-${Math.random() * 2}s`;

            card.innerHTML = `
                <div class="nickname" style="font-size: ${settings.nickSize};">${messageData.nickname}</div>
                <div class="content" style="font-size: ${settings.contentSize};">${messageData.text}</div>
            `;

            container.appendChild(card);
            currentOnScreenIds.add(messageData.id);

            setTimeout(() => {
                card.classList.add('show');
                card.classList.add('hanging');
            }, 50);

            const baseDuration = 10000;
            const extraTime = textLen * 100;
            const duration = Math.random() * 3000 + baseDuration + extraTime;

            setTimeout(() => {
                card.classList.remove('show');
                setTimeout(() => {
                    if (container.contains(card)) {
                        container.removeChild(card);
                        currentOnScreenIds.delete(messageData.id);
                    }
                }, 1000);
            }, duration);
        }

        // ì‹¤í–‰
        setTimeout(() => {
            // ì´ˆê¸° 3ê°œ ì •ë„ ë¹ ë¥´ê²Œ ë„ìš°ê¸°
            for(let i=0; i<3; i++) {
                setTimeout(displayMessage, i * 600);
            }
            setInterval(displayMessage, 2000);
        }, 1500);

    </script>
</body>
</html>
